{% extends "base.html" %}
{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
    <div class="relative">
      <!-- Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ: ÙˆÙ‚ØªÛŒ premium/super ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª -->
      {% if not PREMIUM_FEATURES and not SUPER_FEATURES %}
        <div class="relative w-full overflow-hidden rounded-xl bg-gray-100 flex items-center justify-center" style="min-height: 256px;">
          {% if product.images.first %}
            <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}" class="w-full h-auto max-h-[400px] object-contain">
          {% else %}
            <div class="w-full h-64 flex items-center justify-center bg-gray-200">
              <span class="text-gray-400 text-4xl">ğŸ“·</span>
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="relative w-full overflow-hidden rounded-xl bg-gray-100 flex items-center justify-center" style="min-height: 256px;">
          <div id="slider-container" class="flex w-full" style="transition: transform 0.5s ease-in-out;">
            {% for image in product.images.all %}
              <div class="slide-item w-full flex-shrink-0 flex items-center justify-center" style="min-width: 100%;">
                <img src="{{ image.image.url }}" alt="{{ product.name }}" class="w-full h-auto max-h-[400px] object-contain">
              </div>
            {% empty %}
              <div class="w-full h-64 flex items-center justify-center bg-gray-200">
                <span class="text-gray-400 text-4xl">ğŸ“·</span>
              </div>
            {% endfor %}
          </div>
        </div>

        {% if product.images.count > 1 %}
          <button id="prev-btn" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center hover:bg-black/70 transition z-10" type="button">â€¹</button>
          <button id="next-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center hover:bg-black/70 transition z-10" type="button">â€º</button>

          <div class="flex justify-center gap-2 mt-3" id="dots-container">
            {% for image in product.images.all %}
              <button type="button" class="dot-btn w-2 h-2 md:w-3 md:h-3 rounded-full transition" data-index="{{ forloop.counter0 }}" style="background-color: {% if forloop.first %}var(--primary-color){% else %}#d1d5db{% endif %};"></button>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
    </div>

    <div class="flex flex-col justify-center md:items-start items-center text-center md:text-right">
      <h1 class="text-lg md:text-2xl font-bold text-gray-800 mb-2 md:mb-3">{{ product.name }}</h1>

      <div class="flex items-center gap-2 md:gap-4 mb-3 md:mb-4 flex-wrap justify-center md:justify-start w-full">
        {% if product.discount_percent and product.discount_percent > 0 %}
          <span class="text-sm md:text-lg text-gray-400 line-through">{{ product.persian_price }} ØªÙˆÙ…Ø§Ù†</span>
          <span class="bg-color-dark text-white px-2 py-1 rounded text-xs md:text-sm">{{ product.discount_percent }}% ØªØ®ÙÛŒÙ</span>
          <span class="text-xl md:text-3xl font-bold text-color-light">{{ product.persian_final_price }} ØªÙˆÙ…Ø§Ù†</span>
        {% else %}
          <span class="text-xl md:text-3xl font-bold text-color-light">{{ product.persian_price }} ØªÙˆÙ…Ø§Ù†</span>
        {% endif %}
      </div>

      <p class="text-sm md:text-base text-gray-600 mb-4 md:mb-6 w-full">
        {{ product.description|default:"ØªÙˆØ¶ÛŒØ­Ø§ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯" }}
      </p>

      {% if product.has_colors %}
        <div class="mb-4 md:mb-6 w-full flex justify-center md:justify-start">
          <div class="flex flex-wrap gap-2 w-full">
            {% for color_option in product.colors.all %}
              <button
                type="button"
                class="color-option flex items-center gap-2 px-3 py-2 rounded-full border-2 transition-all duration-200 active:scale-[0.98] {% if color_option.id == initial_color_id %}border-color-light bg-gray-50{% elif color_option.stock == 0 %}border-red-200 bg-red-50 text-gray-500{% else %}border-gray-200 hover:border-color-light{% endif %}"
                data-color-id="{{ color_option.id }}"
                data-color-name="{{ color_option.color_name }}"
                data-color-stock="{{ color_option.stock }}"
                data-in-stock="{% if color_option.stock > 0 %}1{% else %}0{% endif %}"
                onclick="selectProductColor(this)"
              >
                <span class="color-swatch w-5 h-5 md:w-6 md:h-6 rounded-full border border-gray-300 shadow-sm flex-shrink-0 {% if color_option.id == initial_color_id %}ring-2 ring-offset-1 ring-color-light{% endif %}" style="background-color: {{ color_option.color }};"></span>
                <span class="text-sm md:text-base text-gray-700 font-medium">{{ color_option.color_name }}</span>
                {% if color_option.stock == 0 %}
                  <span class="text-xs text-red-500">Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯</span>
                {% endif %}
              </button>
            {% endfor %}
          </div>
        </div>
        <input type="hidden" id="selected-color-id" name="color_id" value="{{ initial_color_id }}">
        <p id="selected-color-status" class="mb-4 text-sm text-red-600 {% if initial_color_in_stock and product.stock > 0 %}hidden{% endif %}">{% if product.stock == 0 %}Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.{% else %}Ø±Ù†Ú¯ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.{% endif %}</p>
      {% endif %}

      <button id="add-to-cart-btn" data-product-in-stock="{% if product.stock > 0 %}1{% else %}0{% endif %}" class="w-full md:w-auto bg-color-light text-white py-2 md:py-3 px-6 md:px-8 rounded-lg shadow-md hover:bg-color-dark hover:shadow-xl hover:-translate-y-0.5 active:bg-color-dark active:scale-[0.99] transition-all duration-200 font-bold text-sm md:text-base disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed disabled:shadow-none disabled:hover:bg-gray-300 disabled:hover:shadow-none disabled:hover:translate-y-0" type="button" onclick="addToCart({{ product.id }})" {% if product.stock == 0 or product.has_colors and not initial_color_in_stock %}disabled{% endif %}>
        ğŸ›’ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
      </button>

      <div class="mt-6 w-full">
        {% if product_spec %}
          <h3 class="text-lg font-bold mb-2">Ù…Ø´Ø®ØµØ§Øª Ù…Ø­ØµÙˆÙ„</h3>
          <div class="overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
            <table class="w-full border-collapse text-sm md:text-base">
              <thead>
                <tr class="bg-gray-100">
                  <th class="p-3 text-right font-semibold text-gray-700">ÙˆÛŒÚ˜Ú¯ÛŒ</th>
                  <th class="p-3 text-left font-semibold text-gray-700">Ù…Ù‚Ø¯Ø§Ø±</th>
                </tr>
              </thead>
              <tbody>
                {% for spec in product_spec %}
                  <tr class="border-t border-gray-100 odd:bg-white even:bg-gray-50">
                    <td class="p-3 text-gray-700 text-right">{{ spec.key }}</td>
                    <td class="p-3 text-gray-800 text-left">{{ spec.value }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>

      <!-- Ø­Ø§Ù„Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡: ÙˆÙ‚ØªÛŒ premium ÛŒØ§ super ÙØ¹Ø§Ù„ Ø§Ø³Øª -->
      {% if PREMIUM_FEATURES or SUPER_FEATURES %}
        <div class="flex gap-2 mt-3 md:mt-4 w-full md:w-auto">
          <button class="flex-1 md:flex-none border-2 border-color-light text-color-light py-2 px-4 rounded-lg hover:bg-color-light hover:text-white transition text-sm md:text-base flex items-center justify-center gap-1" onclick="alert('Ù‚Ø§Ø¨Ù„ÛŒØª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª')" type="button">
            â¤ï¸ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ
            <span class="bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-[10px] md:text-xs px-1.5 py-0.5 rounded font-bold">VIP</span>
          </button>
          <button class="flex-1 md:flex-none border-2 border-gray-300 text-gray-600 py-2 px-4 rounded-lg hover:border-color-light hover:text-color-light transition text-sm md:text-base flex items-center justify-center gap-1" onclick="alert('Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª')" type="button">
            ğŸ”— Ø§Ø´ØªØ±Ø§Ú©
            <span class="bg-gradient-to-r from-yellow-400 to-orange-400 text-white text-[10px] md:text-xs px-1.5 py-0.5 rounded font-bold">VIP</span>
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% if PREMIUM_FEATURES or SUPER_FEATURES %}
<script>
(function () {
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSlider);
  } else {
    initSlider();
  }

  function initSlider() {
    const container = document.getElementById("slider-container");
    if (!container) return;

    const slides = container.querySelectorAll(".slide-item");
    const dots = document.querySelectorAll(".dot-btn");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const totalSlides = slides.length;
    if (!totalSlides) return;

    let currentSlide = 0;
    let autoSlideTimer;

    function updateSlider() {
      container.style.transform = `translateX(-${currentSlide * 100}%)`;
      dots.forEach((dot, index) => {
        dot.style.backgroundColor = index === currentSlide ? "var(--primary-color)" : "#d1d5db";
      });
    }

    function nextSlide() {
      currentSlide = (currentSlide + 1) % totalSlides;
      updateSlider();
    }

    function prevSlide() {
      currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
      updateSlider();
    }

    function startAutoSlide() {
      autoSlideTimer = setInterval(nextSlide, 5000);
    }

    function stopAutoSlide() {
      clearInterval(autoSlideTimer);
    }

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        prevSlide();
        stopAutoSlide();
        startAutoSlide();
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        nextSlide();
        stopAutoSlide();
        startAutoSlide();
      });
    }

    dots.forEach((dot) => {
      dot.addEventListener("click", () => {
        currentSlide = parseInt(dot.getAttribute("data-index"), 10);
        updateSlider();
        stopAutoSlide();
        startAutoSlide();
      });
    });

    container.addEventListener("mouseenter", stopAutoSlide);
    container.addEventListener("mouseleave", startAutoSlide);
    updateSlider();
    startAutoSlide();
  }
})();
</script>
{% endif %}

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function setAddToCartState(disabled, message = "") {
  const addBtn = document.getElementById("add-to-cart-btn");
  const status = document.getElementById("selected-color-status");
  if (!addBtn) return;

  const productInStock = addBtn.dataset.productInStock === "1";
  const finalDisabled = disabled || !productInStock;
  addBtn.disabled = finalDisabled;
  if (status) {
    if (!productInStock) {
      status.textContent = "Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.";
      status.classList.remove("hidden");
    } else {
      status.textContent = message;
      status.classList.toggle("hidden", !message);
    }
  }
}

function selectProductColor(btn) {
  document.querySelectorAll(".color-option").forEach((el) => {
    el.classList.remove("border-color-light", "bg-gray-50", "border-red-300");
    if (el.dataset.inStock === "1") {
      el.classList.add("border-gray-200");
      el.classList.remove("bg-red-50", "text-gray-500");
    } else {
      el.classList.remove("border-gray-200");
      el.classList.add("border-red-200", "bg-red-50", "text-gray-500");
    }

    const swatch = el.querySelector(".color-swatch");
    if (swatch) {
      swatch.classList.remove("ring-2", "ring-offset-1", "ring-color-light");
    }
  });

  btn.classList.remove("border-gray-200", "border-red-200");
  const inStock = parseInt(btn.dataset.colorStock || "0", 10) > 0;
  if (inStock) {
    btn.classList.add("border-color-light", "bg-gray-50");
    btn.classList.remove("bg-red-50", "text-gray-500");
  } else {
    btn.classList.add("border-red-300", "bg-red-50");
    btn.classList.remove("text-gray-500");
  }

  const swatch = btn.querySelector(".color-swatch");
  if (swatch) {
    swatch.classList.add("ring-2", "ring-offset-1", "ring-color-light");
  }

  const colorId = btn.getAttribute("data-color-id");
  const colorInput = document.getElementById("selected-color-id");
  if (colorInput) colorInput.value = colorId;

  setAddToCartState(!inStock, inStock ? "" : "Ø§ÛŒÙ† Ø±Ù†Ú¯ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.");
}

document.addEventListener("DOMContentLoaded", () => {
  const options = Array.from(document.querySelectorAll(".color-option"));
  if (!options.length) return;

  const colorInput = document.getElementById("selected-color-id");
  let initialBtn = null;

  if (colorInput && colorInput.value) {
    initialBtn = document.querySelector(`.color-option[data-color-id="${colorInput.value}"]`);
  }

  if (!initialBtn) {
    initialBtn = options.find((el) => el.dataset.inStock === "1") || options[0];
  }

  if (initialBtn) {
    selectProductColor(initialBtn);
  }
});

function addToCart(productId) {
  const addBtn = document.getElementById("add-to-cart-btn");
  if (addBtn && addBtn.disabled) {
    return;
  }

  const colorId = document.getElementById("selected-color-id")?.value || "";
  const csrftoken = getCookie("csrftoken");

  fetch("/cart/add/", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-CSRFToken": csrftoken || "",
      "X-Requested-With": "XMLHttpRequest"
    },
    body: `product_id=${encodeURIComponent(productId)}&color_id=${encodeURIComponent(colorId)}`
  })
    .then(async (response) => {
      if (!response.ok) {
        let message = "Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±";
        try {
          const data = await response.json();
          message = data?.message || message;
        } catch {
          const txt = await response.text();
          if (txt) message = txt;
        }
        throw new Error(message);
      }
      return response.json();
    })
    .then((data) => {
      if (data?.success) {
        alert("Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.");
      } else {
        alert(data?.message || "Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯");
      }
    })
    .catch((error) => {
      console.error(error);
      alert(error.message || "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±");
    });
}
</script>
{% endblock %}
